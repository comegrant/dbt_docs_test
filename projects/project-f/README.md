# üí∞ Project F

Cheffelo's budget forecasting app

## ü§ñ Running the code

### First time setup
After you have cloned the repo, you need to navigate to the project folder, initiate the virtual environment and install the dependencies.
```
cd projects/project-f
poetry shell
poetry install
```

### Local run
Before you start launching the app, make sure you have an `.env` file in the root of the `sous-chef` repo.

This file contains the credentials used to connect to our Databricks catalog and therefore allow you to execute the SQL queries in the sql folder.

Please fill in the credentials of these variables:

```
DATABRICKS_HOST=https://adb-xxxxxxxxxxxx.azuredatabricks.net/
DATABRICKS_TOKEN=dapixxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```
You can find the databricks host name in the workspace URL.

If you don't have or don't remember a token, you can generate a new token by going to the databricks workspace, and then click on your user icon on the top right corner. Go to `Settings` -> `Developer` -> `Access Tokens` -> `Manage` and click on `Generate New Token`. Choose a sensible expiration period and copy the token into the `.env` file and fill the `DATABRICKS_HOST` variable.

Then launch the app:
```bash
cd projects/project-f
source .venv/bin/activate # activate the virtual environment
streamlit run project_f/main.py
```

<h2>‚ùìHow to work with the app?</h2>
<h3> ‚úÖ Prep work for the app to work </h3>
Before you launch the app, you need to do these:

1. Update the budget period in the `project-f/project_f/data/assumptions/budget_period.py` file. For each budget type (`F1`, `F2`, `F3`, `Budget`), you need to fill in the start and end week number in the format of yyyyww. For example, year 2025 week 2 will be 202502. These values will be used as the default budget weeks. However, you can always override the default values by editing the budget weeks in the UI.

2. (Optional) Fill in or update data files in the `project-f/project_f/data/assumptions` folder. It's an optional step since all files can be modified through the UI.
The files include:
    - `established_retention_rate.tsv`: this file contains the share of customers joined on a certain year that are active at the end of each delivery year. This file typically needs updating as we go on to the new year
    - `ne_decay_rate.csv`: this file contains the decay rate for newly established customers
    - `payment_method_split.csv`: this file contains the share of payment method. In the long run it should be replaced by code to calculate the actual split
    - `source_effect.csv`: sales channels'(such as Web, Phone) effect on cohort
    - `weeks_until_start.csv`: number of weeks after joining before a customer places an order
    - `latest_cohorts.csv`: calculated cohort (# orders placed by the customers per cohort week) for customer's first 12 weeks. Could be automatically generated by the UI if the file does not exist. Aggregated on the month where the customers join. When starting on a new budget project, this file should be regenerated. This can be done by deleting the file, and then let the UI automatically generate the file.
    - `seasonal_adjustment.csv`: this file contains the weekly effect. This file should also be regenerated (by deleting the file and let the UI generate a new file) when starting on a new budget process so that the week numbers get updated.

<h3> üßë‚Äçüíª Working on the UI </h3>

Follow the steps to generate the budget:
1. Select the budget type and brand. The budget process is done one brand at a time.

2. Load the data required.

- The first time when you start on a new budget process, you should select `I need to download/refresh the data from DB`. This step will take ~10 minutes.
- After the download is completed, the downloaded data will be saved in the `project-f/project_f/data/downloads` folder, and you can select `I have downloaded data before` next time to avoid the waiting time as the data will be read in from your local downloaded copy.
- Note that the download data function will download data for all brands. So once you have downloaded the data for one brand, you don't have to download again when working on another brand during the same budgeting process. You can click on `I have downloaded data before` instead to avoid the long waiting time.
- You can also click on the `I need to download/refresh the data from DB` if you want to pull the latest data from DB. The already downloaded data file will be overridden.
- At the moment, the marketing input data is provided by the marketing department through an input into ADB while the sql only pulls data from NDP. However, there is an ingest job set up to sync the shared schema from ADB to NDP. If you need a sync, you can trigger the `temp_ingest_shared_schema_adb` job in the NDP workspace. Afterwards, you can select `I need to download/refresh the data from DB` again to download the latest marketing input data.

3. Play around with the different assumptions by editing the editable fields. If you are happy with your adjustments, you can use the button `override with edited data`, which will save your changes to your local copy of the assumption data files. Next time when you read in the data, the previous saved values will be read in.

4. The cohort adjustment might be the most tedious. Use the ``plot cohort``button to get a more visual presentation of how the cohorts look like for each customer segment and payment method, and decide on which ones to adjust.

5. All the tables and graphs displayed on the UI can be saved to your local machine

6. Use the `Number of Orders by Customer Segment` graph and the various graphs in the appendix to get an overall feeling of whether the budget projections make sense

7. Save outputs into your local machine by clicking on the `Save outputs` button. The outputs will be saved in the `project-f/project_f/data/outputs` folder, organized per brand.
