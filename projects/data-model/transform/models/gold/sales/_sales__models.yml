version: 2

models:
  - name: fact_orders
    description: "Information about what a customer ordered. For orders after 2024 the table also contains information about dish swapping. I.e. which dishes the customer swapped in and out as well as if they made any adjustments to number of portions and meals. Contains both cancelled and finished orders. "
    latest_version: 1
    config:
      alias: fact_orders
      contract:
        enforced: True

    columns:
      - name: pk_fact_orders
        data_type: string
        description: "{{ doc('column__pk_fact_orders') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: menu_year
        data_type: int
        description: "{{ doc('column__menu_year') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: menu_week
        data_type: int
        description: "{{ doc('column__menu_week') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: menu_week_monday_date
        data_type: date
        description: "{{ doc('column__menu_week_monday_date') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: source_created_at
        data_type: timestamp
        description: "{{ doc('column__source_created_at') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: product_variation_quantity
        data_type: int
        description: "{{ doc('column__product_variation_quantity') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: vat
        data_type: decimal(10,8)
        description: "{{ doc('column__vat') }}"

      - name: unit_price_ex_vat
        data_type: decimal(20,6)
        description: "{{ doc('column__unit_price_ex_vat') }}"

      - name: unit_price_inc_vat
        data_type: decimal(32,14)
        description: "{{ doc('column__unit_price_inc_vat') }}"

      - name: total_amount_ex_vat
        data_type: decimal(31,6)
        description: "{{ doc('column__total_amount_ex_vat') }}"

      - name: total_amount_inc_vat
        data_type: decimal(38,9)
        description: "{{ doc('column__total_amount_inc_vat') }}"

      - name: order_line_type_name
        data_type: string
        description: "{{ doc('column__order_line_type_name') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: meal_adjustment_subscription
        data_type: int
        description: ""

      - name: portion_adjustment_subscription
        data_type: int
        description: ""

      - name: is_added_dish
        data_type: int
        description: "{{ doc('column__is_added_dish') }}"

      - name: is_removed_dish
        data_type: int
        description: "{{ doc('column__is_removed_dish') }}"

      - name: is_dish
        data_type: boolean
        description: "{{ doc('column__is_dish') }}"

      - name: has_recipe_leaflets
        data_type: boolean
        description: "{{ doc('column__has_recipe_leaflets') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: has_delivery
        data_type: boolean
        description: "{{ doc('column__has_delivery') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: billing_agreement_id
        data_type: int
        description: "{{ doc('column__billing_agreement_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: billing_agreement_order_id
        data_type: varchar(36)
        description: "{{ doc('column__billing_agreement_order_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: ops_order_id
        data_type: bigint
        description: "{{ doc('column__ops_order_id') }}"

      - name: billing_agreement_order_line_id
        data_type: varchar(36)
        description: "{{ doc('column__billing_agreement_order_line_id') }}"

      - name: company_id
        data_type: varchar(36)
        description: "{{ doc('column__company_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: language_id
        data_type: int
        description: "{{ doc('column__language_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: order_status_id
        data_type: varchar(36)
        description: "{{ doc('column__order_status_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: order_type_id
        data_type: varchar(36)
        description: "{{ doc('column__order_type_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: product_variation_id
        data_type: varchar(36)
        description: "{{ doc('column__product_variation_id') }}"

      - name: preselected_product_variation_id
        data_type: varchar(36)
        description: "{{ doc('column__preselected_product_variation_id') }}"

      - name: recipe_id
        data_type: int
        description: "{{ doc('column__recipe_id') }}"

      - name: preselected_recipe_id
        data_type: int
        description: "{{ doc('column__preselected_recipe_id') }}"

      - name: fk_dim_basket_deviation_origins
        data_type: string
        description: ""
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_basket_deviation_origins')
              field: pk_dim_basket_deviation_origins

      - name: fk_dim_basket_deviation_origins_preselected
        data_type: string
        description: ""
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_basket_deviation_origins')
              field: pk_dim_basket_deviation_origins

      - name: fk_dim_billing_agreements_deviations
        data_type: string
        description: "{{ doc('column__pk_dim_billing_agreements') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_billing_agreements')
              field: pk_dim_billing_agreements

      - name: fk_dim_billing_agreements_ordergen
        data_type: string
        description: "{{ doc('column__pk_dim_billing_agreements') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_billing_agreements')
              field: pk_dim_billing_agreements

      - name: fk_dim_companies
        data_type: string
        description: "{{ doc('column__pk_dim_companies') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_companies')
              field: pk_dim_companies

      - name: fk_dim_date
        data_type: int
        description: "{{ doc('column__pk_dim_date') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_date')
              field: pk_dim_date

      - name: fk_dim_order_statuses
        data_type: string
        description: "{{ doc('column__pk_dim_order_statuses') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_order_statuses')
              field: pk_dim_order_statuses

      - name: fk_dim_order_types
        data_type: string
        description: "{{ doc('column__pk_dim_order_types') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_order_types')
              field: pk_dim_order_types

      - name: fk_dim_products
        data_type: string
        description: "{{ doc('column__pk_dim_products') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_products')
              field: pk_dim_products

      - name: fk_dim_products_preselected
        data_type: string
        description: "{{ doc('column__fk_dim_products_preselected') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_products')
              field: pk_dim_products

      - name: fk_dim_recipes
        data_type: string
        description: "{{ doc('column__pk_dim_recipes') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_recipes')
              field: pk_dim_recipes

      - name: fk_dim_recipes_preselected
        data_type: string
        description: "{{ doc('column__fk_dim_recipes_preselected') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_recipes')
              field: pk_dim_recipes

    versions:
      - v: 1

  - name: dim_order_statuses
    description: ""
    latest_version: 1
    config:
      alias: dim_order_statuses

    versions:
      - v: 1

  - name: dim_order_types
    description: ""
    latest_version: 1
    config:
      alias: dim_order_types

    versions:
      - v: 1

  - name: dim_billing_agreements
    description: ""
    latest_version: 1
    config:
      alias: dim_billing_agreements
      contract:
        enforced: True

    columns:
      - name: pk_dim_billing_agreements
        data_type: string
        description: "{{ doc('column__pk_dim_billing_agreements') }}"
        constraints:
          - type: unique
        data_tests:
          - unique

      - name: billing_agreement_id
        data_type: int
        description: "{{ doc('column__billing_agreement_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: company_id
        data_type: varchar(36)
        description: "{{ doc('column__company_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: sales_point_id
        data_type: int
        description: "{{ doc('column__sales_point_id') }}"

      - name: billing_agreement_preferences_updated_id
        data_type: string
        description: "{{ doc('column__billing_agreement_preferences_updated_id') }}"

      - name: billing_agreement_basket_product_updated_id
        data_type: string
        description: ""

      - name: valid_from
        data_type: timestamp
        description: "{{ doc('column__valid_from') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: valid_to
        data_type: timestamp
        description: "{{ doc('column__valid_to') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: is_current
        data_type: boolean
        description: "{{ doc('column__is_current') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: payment_method
        data_type: string
        description: "{{ doc('column__payment_method') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: signup_source
        data_type: string
        description: "{{ doc('column__signup_source') }}"

      - name: signup_salesperson
        data_type: string
        description: "{{ doc('column__signup_salesperson') }}"

      - name: billing_agreement_status_name
        data_type: string
        description: "{{ doc('column__billing_agreement_status_name') }}"
      # This can be null until we have added history
      #  constraints:
      #    - type: not_null
      #  data_tests:
      #    - not_null

      # Has bugs. Not needed to fix before Onesub launch.
      #- name: loyalty_level_id
      #  data_type: char(36)
      #  description: "{{ doc('column__loyalty_level_id') }}"

      - name: signup_at
        data_type: timestamp
        description: "{{ doc('column__signup_at') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: signup_date
        data_type: date
        description: "{{ doc('column__signup_date') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: signup_year_day
        data_type: int
        description: "{{ doc('column__signup_year_day') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: signup_month_day
        data_type: int
        description: "{{ doc('column__signup_month_day') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: signup_week_day
        data_type: int
        description: "{{ doc('column__signup_week_day') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: signup_week
        data_type: int
        description: "{{ doc('column__signup_week') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: signup_month
        data_type: int
        description: "{{ doc('column__signup_month') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: signup_quarter
        data_type: int
        description: "{{ doc('column__signup_quarter') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: signup_year
        data_type: int
        description: "{{ doc('column__signup_year') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: first_menu_week_monday_date
        data_type: date
        description: "{{ doc('column__first_menu_week_monday_date') }}"

      - name: first_menu_week_week
        data_type: int
        description: "{{ doc('column__first_menu_week_week') }}"

      - name: first_menu_week_month
        data_type: int
        description: "{{ doc('column__first_menu_week_month') }}"

      - name: first_menu_week_quarter
        data_type: int
        description: "{{ doc('column__first_menu_week_quarter') }}"

      - name: first_menu_week_year
        data_type: int
        description: "{{ doc('column__first_menu_week_year') }}"

      - name: preselector_flag
        data_type: string
        description: "{{ doc('column__preselector_flag') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: onesub_flag
        data_type: string
        description: "{{ doc('column__onesub_flag') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: onesub_beta_flag
        data_type: string
        description: "{{ doc('column__onesub_beta_flag') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

    versions:
      - v: 1

  - name: dim_preferences
    description: "Contains all preferences and attributes that can belong to a billing agreement."
    latest_version: 1
    config:
      alias: dim_preferences

    columns:
      - name: pk_dim_preferences
        data_type: string
        description: "{{ doc('column__pk_dim_preferences') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: preference_id
        data_type: char(36)
        description: "{{ doc('column__preference_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: company_id
        data_type: char(36)
        description: "{{ doc('column__company_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: preference_type_id
        data_type: char(36)
        description: "{{ doc('column__preference_type_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: preference_name_general
        data_type: string
        description: "{{ doc('column__preference_name_general') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: preference_description_general
        data_type: string
        description: "{{ doc('column__preference_description_general') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null


      - name: preference_name
        data_type: string
        description: "{{ doc('column__preference_name') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: preference_description
        data_type: string
        description: "{{ doc('column__preference_description') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: preference_type_name
        data_type: string
        description: "{{ doc('column__preference_type_name') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: preference_type_description
        data_type: string
        description: "{{ doc('column__preference_type_description') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: is_active_preference
        data_type: boolean
        description: "{{ doc('column__is_active_preference') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: is_allergen
        data_type: boolean
        description: "{{ doc('column__is_allergen') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

    versions:
      - v: 1

  - name: dim_preference_combinations
    description: "Contains all preference combinations for the agreements, as well as a list with only concept preferences and a list with only taste preferences."
    latest_version: 1
    config:
      alias: dim_preference_combinations

    columns:
      - name: pk_dim_preference_combinations
        data_type: string
        description: "{{ doc('column__pk_dim_preference_combinations') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: fk_dim_billing_agreements
        data_type: string
        description: "{{ doc('column__pk_dim_billing_agreements') }}"
        constraints:
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: preference_combinations
        data_type: string
        description: "{{ doc('column__preference_combinations') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: preference_id_combinations
        data_type: string
        description: "{{ doc('column__preference_id_combinations') }}"

      - name: concept_combinations
        data_type: string
        description: "{{ doc('column__concept_combinations') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: preference_id_combinations_concept_type
        data_type: string
        description: "{{ doc('column__preference_id_combinations_concept_type') }}"

      - name: taste_preference_combinations
        data_type: string
        description: "{{ doc('column__taste_preference_combinations') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: preference_id_combinations_taste_type
        data_type: string
        description: "{{ doc('column__preference_id_combinations_taste_type') }}"

      - name: number_of_preferences
        data_type: int
        description: "{{ doc('column__number_of_preferences') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: number_of_concept_preferences
        data_type: int
        description: "{{ doc('column__number_of_concept_preferences') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: number_of_taste_preferences
        data_type: int
        description: "{{ doc('column__number_of_taste_preferences') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

    versions:
    - v: 1


  - name: bridge_billing_agreements_preferences
    description: ""
    latest_version: 1
    config:
      alias: bridge_billing_agreements_preferences
    constraints:
      - type: primary_key
        columns: [pk_bridge_billing_agreements_preferences]

    columns:
      - name: pk_bridge_billing_agreements_preferences
        data_type: string
        description: "{{ doc('column__pk_bridge_billing_agreements_preferences') }}"
        constraints:
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: fk_dim_billing_agreements
        data_type: string
        description: "{{ doc('column__pk_dim_billing_agreements') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_billing_agreements')
              field: pk_dim_billing_agreements

      - name: fk_dim_preferences
        data_type: string
        description: "{{ doc('column__pk_dim_preferences') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_preferences')
              field: pk_dim_preferences

      - name: billing_agreement_preferences_updated_id
        data_type: string
        description: "{{ doc('column__billing_agreement_preferences_updated_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: preference_id
        data_type: string
        description: "{{ doc('column__preference_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: company_id
        data_type: string
        description: "{{ doc('column__company_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

    versions:
      - v: 1

  - name: fact_billing_agreements_daily
    description: "All billing agreements, except deleted once, exploded to each day."
    latest_version: 1
    config:
      alias: fact_billing_agreements_daily

    versions:
      - v: 1

  - name: fact_billing_agreements_weekly
    description: "All billing agreements, included deleted once, exploded to each week."
    latest_version: 1
    config:
      alias: fact_billing_agreements_weekly

    versions:
      - v: 1

  - name: fact_subscription_quiz
    description: "Events relating to when a customer updates their subscription."
    latest_version: 1
    config:
      alias: fact_subscription_quiz

    versions:
      - v: 1

    columns:
      - name: pk_fact_subscription_quiz
        data_type: string
        description: "{{ doc('column__pk_fact_subscription_quiz') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: fk_dim_billing_agreements
        data_type: string
        description: "{{ doc('column__pk_dim_billing_agreements') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_billing_agreements')
              field: pk_dim_billing_agreements

      - name: fk_dim_companies
        data_type: string
        description: "{{ doc('column__pk_dim_companies') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_companies')
              field: pk_dim_companies

      - name: fk_dim_date_source_created_at_segment
        data_type: bigint
        description: "{{ doc('column__fk_dim_date_source_created_at_segment') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_date')
              field: pk_dim_date

      - name: fk_dim_time_source_created_at_segment
        data_type: string
        description: "{{ doc('column__fk_dim_time_source_created_at_segment') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_time')
              field: pk_dim_time

      - name: has_started_subscription_quiz
        data_type: int
        description: "{{ doc('column__has_started_subscription_quiz') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - accepted_values:
              values: [0, 1]

      - name: has_completed_subscription_quiz
        data_type: int
        description: "{{ doc('column__has_completed_subscription_quiz') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - accepted_values:
              values: [0, 1]

  - name: dim_preselector_versions
    description: "Contains different versions of the preselector codebase."
    latest_version: 1
    config:
      alias: dim_preselector_versions
      contract:
        enforced: true

    versions:
      - v: 1
    columns:
      - name: pk_dim_preselector_versions
        data_type: string
        description: "{{ doc('column__pk_dim_preselector_versions') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null
      - name: full_commit_sha
        data_type: string
        description: "{{ doc('column__full_commit_sha') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
      - name: short_commit_sha
        data_type: string
        description: "{{ doc('column__short_commit_sha') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
      - name: source_model_version_first_used_at
        data_type: timestamp
        description: "{{ doc('column__source_model_version_first_used_at') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
      - name: source_model_version_latest_used_at
        data_type: timestamp
        description: "{{ doc('column__source_model_version_latest_used_at') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
      - name: version_number
        data_type: int
        description: "{{ doc('column__preselector_version_number') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
