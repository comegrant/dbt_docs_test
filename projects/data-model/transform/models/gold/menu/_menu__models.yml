version: 2

models:
  - name: dim_products
    description: ""
    latest_version: 1
    config:
      alias: dim_products
      contract:
        enforced: true

    columns:
      - name: pk_dim_products
        data_type: string
        description: "{{ doc('column__pk_dim_products') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: product_concept_id
        data_type: char(36)
        description: "{{ doc('column__product_concept_id') }}"

      - name: product_type_id
        data_type: char(36)
        description: "{{ doc('column__product_type_id') }}"
        data_tests:
          - not_null

      - name: product_id
        data_type: char(36)
        description: "{{ doc('column__product_id') }}"
        data_tests:
          - not_null

      - name: product_status_id
        data_type: int
        description: "{{ doc('column__product_status_id') }}"
        data_tests:
          - not_null

      - name: product_variation_id
        data_type: char(36)
        description: "{{ doc('column__product_variation_id') }}"
        data_tests:
          - not_null

      - name: company_id
        data_type: char(36)
        description: "{{ doc('column__company_id') }}"
        data_tests:
          - not_null

      - name: product_concept_name
        data_type: string
        description: "{{ doc('column__product_concept_name') }}"

      - name: product_type_name
        data_type: string
        description: "{{ doc('column__product_type_name') }}"
        data_tests:
          - not_null

      - name: product_name
        data_type: string
        description: "{{ doc('column__product_name') }}"
        data_tests:
          - not_null

      - name: product_status_name
        data_type: string
        description: "{{ doc('column__product_status_name') }}"
        data_tests:
          - not_null

      - name: product_variation_name
        data_type: string
        description: "{{ doc('column__product_variation_name') }}"
        data_tests:
          - not_null

      - name: sku
        data_type: string
        description: "{{ doc('column__sku') }}"
        data_tests:
          - not_null

      - name: meals
        data_type: int
        description: "{{ doc('column__meals') }}"

      - name: portions
        data_type: int
        description: "{{ doc('column__portions') }}"

      - name: portion_name
        data_type: string
        description: "{{ doc('column__portion_name') }}"

      - name: is_financial
        data_type: boolean
        description: "{{ doc('column__is_financial') }}"
        data_tests:
          - not_null

    versions:
      - v: 1

  - name: dim_recipe_reaction_types
    description: "When choosing dishes the customer can react with a heart or a dislike. This table holds information about\
      \ the different types of reactions a customer can make."
    latest_version: 1
    config:
      alias: dim_recipe_reaction_types
      contract:
        enforced: true

    columns:
      - name: pk_dim_recipe_reaction_types
        data_type: string
        description: "{{ doc('column__pk_dim_recipe_reaction_types') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: recipe_reaction_type_id
        data_type: int
        description: "{{ doc('column__recipe_favorite_type_id') }}"
        constraints:
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: recipe_reaction_type_name
        data_type: string
        description: "{{ doc('column__recipe_favorite_type_name') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

    versions:
      - v: 1

  - name: fact_recipe_reactions
    description: "When choosing dishes the customer can react with a heart or a dislike. The table stores the reaction made\
      \ by customers."
    latest_version: 1
    config:
      alias: fact_recipe_reactions
      contract:
        enforced: true

    columns:
      - name: pk_fact_recipe_reactions
        data_type: string
        description: "{{ doc('column__pk_fact_recipe_reactions') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: recipe_reaction_id
        data_type: varchar(36)
        description: "{{ doc('column__recipe_favorite_id') }}"
        constraints:
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: billing_agreement_id
        data_type: int
        description: "{{ doc('column__billing_agreement_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: recipe_id
        data_type: int
        description: "{{ doc('column__recipe_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: main_recipe_id
        data_type: int
        description: "{{ doc('column__main_recipe_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: recipe_reaction_type_id
        data_type: int
        description: "{{ doc('column__recipe_favorite_type_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: is_active_reaction
        data_type: boolean
        description: "{{ doc('column__is_active_reaction') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: source_created_at
        data_type: timestamp
        description: "{{ doc('column__source_created_at') }}"
        data_tests:
          - not_null

      - name: fk_dim_billing_agreements
        data_type: string
        description: "{{ doc('column__pk_dim_billing_agreements') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_billing_agreements')
              field: pk_dim_billing_agreements

      - name: fk_dim_recipes
        data_type: string
        description: "{{ doc('column__pk_dim_recipes') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_recipes')
              field: pk_dim_recipes

      - name: fk_dim_dates
        data_type: int
        description: "{{ doc('column__pk_dim_dates') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_dates')
              field: pk_dim_dates

      - name: fk_dim_companies
        data_type: string
        description: "{{ doc('column__pk_dim_companies') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_companies')
              field: pk_dim_companies

      - name: fk_dim_time
        data_type: int
        description: "{{ doc('column__pk_dim_time') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_time')
              field: pk_dim_time

      - name: fk_dim_recipe_reaction_types
        data_type: string
        description: "{{ doc('column__pk_dim_recipe_reaction_types') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_recipe_reaction_types')
              field: pk_dim_recipe_reaction_types

    versions:
      - v: 1

  - name: dim_recipes
    description: ""
    latest_version: 1
    config:
      alias: dim_recipes
      contract:
        enforced: true

    columns:
      - name: pk_dim_recipes
        data_type: string
        description: "{{ doc('column__pk_dim_recipes') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: recipe_id
        data_type: int
        description: "{{ doc('column__recipe_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: recipe_metadata_id
        data_type: int
        description: "{{ doc('column__recipe_metadata_id') }}"

      - name: main_recipe_id
        data_type: int
        description: "{{ doc('column__main_recipe_id') }}"

      - name: main_recipe_variation_id
        data_type: string
        description: "{{ doc('column__main_recipe_variation_id') }}"

      - name: main_recipe_variation_suffix
        data_type: string
        description: "{{ doc('column__main_recipe_variation_suffix') }}"

      - name: recipe_status_code_id
        data_type: int
        description: "{{ doc('column__recipe_status_code_id') }}"

      - name: recipe_main_ingredient_id
        data_type: int
        description: "{{ doc('column__recipe_main_ingredient_id') }}"

      - name: recipe_difficulty_level_id
        data_type: int
        description: "{{ doc('column__recipe_difficulty_level_id') }}"

      - name: language_id
        data_type: int
        description: "{{ doc('column__language_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: cooking_time_from
        data_type: int
        description: "{{ doc('column__cooking_time_from') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: cooking_time_to
        data_type: int
        description: "{{ doc('column__cooking_time_to') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: cooking_time
        data_type: string
        description: "{{ doc('column__cooking_time') }}"

      - name: has_recipe_photo
        data_type: boolean
        description: "{{ doc('column__has_recipe_photo') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: recipe_name
        data_type: string
        description: "{{ doc('column__recipe_name') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: recipe_photo_caption
        data_type: string
        description: "{{ doc('column__recipe_photo_caption') }}"

      - name: recipe_general_text
        data_type: string
        description: "{{ doc('column__recipe_general_text') }}"

      - name: recipe_description
        data_type: string
        description: "{{ doc('column__recipe_description') }}"

      - name: recipe_difficulty_name
        data_type: string
        description: "{{ doc('column__recipe_difficulty_name') }}"

      - name: recipe_main_ingredient_name_local
        data_type: string
        description: "{{ doc('column__recipe_main_ingredient_name_local') }}"

      - name: recipe_main_ingredient_name_english
        data_type: string
        description: "{{ doc('column__recipe_main_ingredient_name_english') }}"

      - name: main_recipe_name
        data_type: string
        description: "{{ doc('column__main_recipe_name') }}"

      - name: is_main_recipe
        data_type: boolean
        description: "{{ doc('column__is_main_recipe') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: is_in_recipe_universe
        data_type: boolean
        description: "{{ doc('column__is_in_recipe_universe') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: recipe_shelf_life_days
        data_type: int
        description: "{{ doc('column__recipe_shelf_life_days') }}"

      - name: recipe_comment
        data_type: string
        description: "{{ doc('column__recipe_comment') }}"

      - name: recipe_chef_tip
        data_type: string
        description: "{{ doc('column__recipe_chef_tip') }}"

    versions:
      - v: 1


  - name: dim_ingredients
    description: ""
    latest_version: 1
    config:
      alias: dim_ingredients

    columns:
      - name: pk_dim_ingredients
        data_type: string
        description: "{{ doc('column__pk_dim_ingredients') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: ingredient_id
        data_type: int
        description: "{{ doc('column__ingredient_id') }}"
        data_tests:
          - not_null

      - name: allergy_id
        data_type: int
        description: "{{ doc('column__allergy_id') }}"

      - name: language_id
        data_type: int
        description: "{{ doc('column__language_id') }}"
        data_tests:
          - not_null

      - name: ingredient_name
        data_type: string
        description: "{{ doc('column__ingredient_name') }}"

      - name: allergy_name
        data_type: string
        description: "{{ doc('column__allergy_name') }}"

      - name: main_group
        data_type: string
        description: "{{ doc('column__main_group') }}"

      - name: category_group
        data_type: string
        description: "{{ doc('column__category_group') }}"

      - name: product_group
        data_type: string
        description: "{{ doc('column__product_group') }}"

      - name: category_level1
        data_type: int
        description: "{{ doc('column__category_level1') }}"

      - name: category_level2
        data_type: int
        description: "{{ doc('column__category_level2') }}"

      - name: category_level3
        data_type: int
        description: "{{ doc('column__category_level3') }}"

      - name: category_level4
        data_type: int
        description: "{{ doc('column__category_level4') }}"

      - name: category_level5
        data_type: int
        description: "{{ doc('column__category_level5') }}"

    versions:
      - v: 1

  - name: dim_taxonomies
    description: "Table of all taxonomies which are used to tag recipes"
    latest_version: 1
    config:
      alias: dim_taxonomies
      contract:
        enforced: true

    columns:
      - name: pk_dim_taxonomies
        data_type: string
        description: "{{ doc('column__pk_dim_taxonomies') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: taxonomy_id
        data_type: int
        description: "{{ doc('column__taxonomy_id') }}"
        data_tests:
          - not_null

      - name: language_id
        data_type: int
        description: "{{ doc('column__language_id') }}"
        data_tests:
          - not_null

      - name: taxonomy_name_local
        data_type: string
        description: "{{ doc('column__taxonomy_name_local') }}"
        data_tests:
          - not_null

      - name: taxonomy_name_english
        data_type: string
        description: "{{ doc('column__taxonomy_name_english') }}"

      - name: taxonomy_status_name_local
        data_type: string
        description: "{{ doc('column__taxonomy_status_name_local') }}"
        data_tests:
          - not_null

      - name: taxonomy_status_name_english
        data_type: string
        description: "{{ doc('column__taxonomy_status_name_english') }}"
        data_tests:
          - not_null

      - name: taxonomy_type_name
        data_type: string
        description: "{{ doc('column__taxonomy_type_name') }}"
        data_tests:
          - not_null

    versions:
      - v: 1

  - name: bridge_dim_recipes_dim_taxonomies
    description: "Bridge table connecting Dim Recipes and Dim Taxonomies"
    latest_version: 1
    config:
      alias: bridge_dim_recipes_dim_taxonomies

    columns:
      - name: pk_bridge_dim_recipes_dim_taxonomies
        data_type: string
        description: "{{ doc('column__pk_bridge_dim_recipes_dim_taxonomies') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: fk_dim_recipes
        data_type: string
        description: "{{ doc('column__pk_dim_recipes') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_recipes')
              field: pk_dim_recipes

      - name: fk_dim_taxonomies
        data_type: string
        description: "{{ doc('column__pk_dim_taxonomies') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_taxonomies')
              field: pk_dim_taxonomies

    versions:
      - v: 1

  - name: bridge_recipes_ingredients
    description: "Bridge table connecting recipes and ingredients"
    latest_version: 1
    config:
      alias: bridge_recipes_ingredients

    columns:
      - name: pk_bridge_recipes_ingredients
        data_type: string
        description: "{{ doc('column__pk_bridge_recipes_ingredients') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: fk_dim_recipes
        data_type: string
        description: "{{ doc('column__pk_dim_recipes') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_recipes')
              field: pk_dim_recipes

      - name: fk_dim_ingredients
        data_type: string
        description: "{{ doc('column__fk_dim_ingredients') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_ingredients')
              field: pk_dim_ingredients

      - name: recipe_id
        data_type: int
        description: "{{ doc('column__recipe_id') }}"
        data_tests:
          - not_null

      - name: recipe_portion_id
        data_type: int
        description: "{{ doc('column__recipe_portion_id') }}"
        data_tests:
          - not_null

      - name: language_id
        data_type: int
        description: "{{ doc('column__language_id') }}"
        data_tests:
          - not_null

      - name: ingredient_id
        data_type: int
        description: "{{ doc('column__ingredient_id') }}"
        data_tests:
          - not_null

      - name: allergy_id
        data_type: int
        description: "{{ doc('column__allergy_id') }}"

    versions:
      - v: 1

  - name: fact_menus
    description: ""
    latest_version: 1
    config:
      alias: fact_menus
      contract:
        enforced: true

    columns:
      - name: pk_fact_menus
        data_type: string
        description: "{{ doc('column__pk_fact_menus') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
      # Is not unique due to problems with menu_id = 36 in source
          - unique:
              config:
                severity: error
                error_if: ">203"
                warn_if: "<203"
          - not_null

      - name: weekly_menu_id
        data_type: int
        description: "{{ doc('column__weekly_menu_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: company_id
        data_type: char(36)
        description: "{{ doc('column__company_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: menu_id
        data_type: int
        description: "{{ doc('column__menu_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: menu_variation_id
        data_type: int
        description: "{{ doc('column__menu_variation_id') }}"

      - name: product_variation_id
        data_type: char(36)
        description: "{{ doc('column__product_variation_id') }}"
        # some old data is missing product variation ids
        data_tests:
          - not_null:
              config:
                severity: error
                error_if: ">44"
                warn_if: "<44"

      - name: menu_recipe_id
        data_type: int
        description: "{{ doc('column__menu_recipe_id') }}"
        data_tests:
          - not_null:
              config:
                severity: warn

      - name: recipe_id
        data_type: int
        description: "{{ doc('column__recipe_id') }}"
        data_tests:
          - not_null:
              config:
                severity: warn

      - name: recipe_portion_id
        data_type: int
        description: "{{ doc('column__recipe_portion_id') }}"
        data_tests:
          - not_null:
              config:
                severity: warn

      - name: portion_id
        data_type: int
        description: "{{ doc('column__portion_id') }}"
        data_tests:
          - not_null:
              where: "menu_year >= 2019" # can be removed after filter to fact menus is added

      - name: portion_id_menus
        data_type: int
        description: "{{ doc('column__portion_id_menu_variations') }}"
        data_tests:
          - not_null:
              where: "menu_year >= 2019" # can be removed after filter to fact menus is added
          - equal_to_column:
              value: portion_id_products
              config:
                # There are known issues before 2023-05-08
                where: 'portion_id_products is not null and menu_week_monday_date > DATE("2023-05-08")'

      - name: portion_id_recipes
        data_type: int
        description: "This column can be removed as it is duplicate with portion_id_menus, but we keep it for debugging reasons for now."

      - name: portion_id_products
        data_type: int
        description: "{{ doc('column__portion_id_products') }}"
        data_tests:
          - not_null:
              # There are known issues before 2023-07-17
              where: 'menu_week_monday_date > DATE("2023-07-17")'

      - name: menu_year
        data_type: smallint
        description: "{{ doc('column__menu_year') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: menu_week
        data_type: smallint
        description: "{{ doc('column__menu_week') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: menu_week_monday_date
        data_type: date
        description: "{{ doc('column__menu_week_monday_date') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: menu_number_days
        data_type: smallint
        description: "{{ doc('column__menu_number_days') }}"

      - name: menu_recipe_order
        data_type: smallint
        description: "{{ doc('column__menu_recipe_order') }}"
        data_tests:
          - not_null:
              config:
                severity: warn

      - name: portion_quantity
        data_type: int
        description: "{{ doc('column__portion_quantity') }}"

      - name: portion_name
        data_type: string
        description: "{{ doc('column__portion_name') }}"

      - name: is_selected_menu
        data_type: boolean
        description: ""

      - name: is_locked_recipe
        data_type: boolean
        description: ""

      - name: is_artificial_week
        data_type: boolean
        description: "{{ doc('column__is_artificial_week') }}"

      - name: is_dish
        data_type: boolean
        description: "{{ doc('column__is_dish') }}"

      - name: has_menu_recipes
        data_type: boolean
        description: "{{ doc('column__has_menu_recipes') }}"

      - name: has_recipe_portions
        data_type: boolean
        description: "{{ doc('column__has_recipe_portions') }}"

      - name: fk_dim_recipes
        data_type: string
        description: "{{ doc('column__pk_dim_recipes') }}"
        # has missing recipe ids
        #constraints:
        #  - type: not_null
        #data_tests:
        #  - not_null
        #  - relationships:
        #      to: ref('dim_recipes')
        #      field: pk_dim_recipes

      - name: fk_dim_products
        data_type: string
        description: "{{ doc('column__pk_dim_products') }}"
        # has missing product variations due to some old data
        #constraints:
        #  - type: not_null
        #data_tests:
        #  - not_null
        #  - relationships:
        #      to: ref('dim_products')
        #      field: pk_dim_products

      - name: fk_dim_portions
        data_type: string
        description: "{{ doc('column__pk_dim_portions') }}"
        data_tests:
          - not_null:
              where: "menu_year >= 2019" # can be removed after filter to fact menus is added
          - relationships:
              to: ref('dim_portions')
              field: pk_dim_portions

      - name: fk_dim_date
        data_type: int
        description: "{{ doc('column__pk_dim_dates') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_dates')
              field: pk_dim_dates

      - name: fk_dim_companies
        data_type: string
        description: "{{ doc('column__pk_dim_companies') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_companies')
              field: pk_dim_companies

    versions:
      - v: 1

  - name: dim_portions
    description: "Dimension that lets the user filter on number of portions and plus size portions."
    data_tests:
      - unique:
          # We need this to be unique to avoid duplicates when joining dim_portions with
          # fact tables based on the portions of the products. When considering portions of the products we don't have
          # portion_id and need to use the portion name in the join to find the foreign key to dim_portions.
          column_name: "(portion_name_local || '-' || language_id)"
    latest_version: 1
    config:
      alias: dim_portions

    columns:
      - name: pk_dim_portions
        data_type: string
        description: "{{ doc('column__pk_dim_portions') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
          - unique
          - not_null

      - name: portion_id
        data_type: int
        description: "{{ doc('column__portion_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: language_id
        data_type: int
        description: "{{ doc('column__language_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: portions
        data_type: int
        description: "{{ doc('column__portion_size') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: portion_name_local
        data_type: string
        description: "{{ doc('column__portion_name_local') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: portion_name_english
        data_type: string
        description: "{{ doc('column__portion_name_english') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: portion_status_code_id
        data_type: int
        description: "{{ doc('column__portion_status_code_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: portion_status_name_local
        data_type: string
        description: "{{ doc('column__portion_status_name_local') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: portion_status_name_english
        data_type: string
        description: "{{ doc('column__portion_status_name_english') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

    versions:
      - v: 1
