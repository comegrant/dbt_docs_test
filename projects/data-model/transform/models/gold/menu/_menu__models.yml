version: 2

models:
  - name: dim_products
    description: ""
    latest_version: 1
    config:
      alias: dim_products

    versions:
      - v: 1

  - name: dim_recipes
    description: ""
    latest_version: 1
    config:
      alias: dim_recipes

    versions:
      - v: 1

  - name: fact_menus
    description: ""
    latest_version: 1
    config:
      alias: fact_menus
      contract:
        enforced: True
        
    columns:
      - name: pk_fact_menus
        data_type: string
        description: "{{ doc('column__pk_fact_menus') }}"
        constraints:
          - type: primary_key
          - type: unique
          - type: not_null
        data_tests:
      # Is not unique due to problems with menu_id = 36 in source
          - unique:
              config:
                severity: error
                error_if: ">203"
                warn_if: "<203"
          - not_null

      - name: weekly_menu_id
        data_type: int
        description: "{{ doc('column__weekly_menu_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: company_id
        data_type: char(36)
        description: "{{ doc('column__company_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: menu_id
        data_type: int
        description: "{{ doc('column__menu_id') }}"
        constraints:
          - type: not_null        
        data_tests:
          - not_null

      - name: product_variation_id
        data_type: char(36)
        description: "{{ doc('column__product_variation_id') }}"
        # some old data is missing product variation ids
        data_tests:
          - not_null:
              config:
                severity: error
                error_if: ">44"
                warn_if: "<44"

      - name: menu_recipe_id
        data_type: int
        description: "{{ doc('column__menu_recipe_id') }}"
        data_tests:
          - not_null:
              config:
                  severity: warn

      - name: recipe_id
        data_type: int
        description: "{{ doc('column__recipe_id') }}"
        data_tests:
          - not_null:
              config:
                  severity: warn

      - name: recipe_portion_id
        data_type: int
        description: "{{ doc('column__recipe_portion_id') }}"
        data_tests:
          - not_null:
              config:
                  severity: warn

      - name: portion_id
        data_type: int
        description: "{{ doc('column__portion_id') }}"
        data_tests:
          - not_null:
              config:
                severity: error
                error_if: ">44"
                warn_if: "<44"

      - name: menu_year
        data_type: smallint
        description: "{{ doc('column__menu_year') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: menu_week
        data_type: smallint
        description: "{{ doc('column__menu_week') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: menu_week_monday_date
        data_type: date
        description: "{{ doc('column__menu_week_monday_date') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: menu_number_days
        data_type: smallint
        description: "{{ doc('column__menu_number_days') }}"
        data_tests:
          - not_null:
              config:
                severity: error
                error_if: ">44"
                warn_if: "<44"

      - name: menu_recipe_order
        data_type: smallint
        description: "{{ doc('column__menu_recipe_order') }}"
        data_tests:
          - not_null:
              config:
                  severity: warn

      - name: portion_size
        data_type: int
        description: "{{ doc('column__portion_size') }}"
        data_tests:
          - not_null:
              config:
                severity: error
                error_if: ">44"
                warn_if: "<44"

      - name: weekly_menu_status_code_id
        data_type: int
        description: "{{ doc('column__pim_status_code_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: menu_status_code_id
        data_type: int
        description: "{{ doc('column__pim_status_code_id') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null

      - name: recipe_status_code_id
        data_type: int
        description: "{{ doc('column__pim_status_code_id') }}"
        # has missing recipe_ids
        #constraints:
        #  - type: not_null
        #data_tests:
        #  - not_null:
        #      config:
        #          severity: warn

      - name: portion_status_code_id
        data_type: int
        description: "{{ doc('column__pim_status_code_id') }}"
        # has missing portion_ids
        #constraints:
        #  - type: not_null
        #data_tests:
        #  - not_null:
        #      config:
        #        severity: error
        #        error_if: ">44"
        #       warn_if: "<44"
        
      - name: is_artificial_week
        data_type: boolean
        description: "{{ doc('column__is_artificial_week') }}"

      - name: is_dish
        data_type: boolean
        description: "{{ doc('column__is_dish') }}"

      - name: has_menu_recipes
        data_type: boolean
        description: "{{ doc('column__has_menu_recipes') }}"

      - name: has_recipe_portions
        data_type: boolean
        description: "{{ doc('column__has_recipe_portions') }}"

      - name: fk_dim_recipes
        data_type: string
        description: "{{ doc('column__pk_dim_recipes') }}"
        # has missing recipe ids
        #constraints:
        #  - type: not_null
        #data_tests:
        #  - not_null
        #  - relationships:
        #      to: ref('dim_recipes')
        #      field: pk_dim_recipes

      - name: fk_dim_products
        data_type: string
        description: "{{ doc('column__pk_dim_products') }}"
        # has missing product variations due to some old data
        #constraints:
        #  - type: not_null
        #data_tests:
        #  - not_null
        #  - relationships:
        #      to: ref('dim_products')
        #      field: pk_dim_products

      - name: fk_dim_date
        data_type: int
        description: "{{ doc('column__pk_dim_date') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_date')
              field: pk_dim_date

      - name: fk_dim_companies
        data_type: string
        description: "{{ doc('column__pk_dim_companies') }}"
        constraints:
          - type: not_null
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_companies')
              field: pk_dim_companies

    versions:
      - v: 1