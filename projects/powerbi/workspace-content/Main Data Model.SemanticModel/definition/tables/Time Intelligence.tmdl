/// This Calculation Group, named 'Time Intelligence', provides a flexible framework
/// to apply common time-based calculations to any measure in the model.
/// Simply place the 'Time Intelligence'[Time Calculation] column on a visual,
/// or use it in a slicer to dynamically apply the selected calculation to any measure.
///
/// Available Calculation Items:
///
/// - Current: Returns the original value of the measure without any time modification.
///
/// - PY (Previous Year): Returns the value of the measure for the same period one year earlier.
///   It adapts based on what time hierarchy is in scope (Date, Calendar Month, Financial Quarter, etc.).
///
/// - Diff PY: Calculates the absolute difference between the Current and PY values.
///
/// - YOY%: Calculates the Year-over-Year percentage change: (Current - PY) / PY.
///
/// - CY/PY: Returns the ratio between Current and PY values, often used to analyze relative growth.
///
/// - YTD (Year-To-Date): Accumulates values from the start of the year to the current date.
///
/// - PYTD (Previous Year-To-Date): Returns the same YTD value, but for the previous year.
///
/// - Rolling X days: Returns a rolling sum over a defined number of past days.
///   By default, it uses the last 90 days, but this can be adjusted using the
///   '(Param) Days in Rolling Period'[Days in Rolling Period Value] parameter.
///   If the user applies a filter over a broader time range (e.g. a week or a month),
///   the rolling window will be calculated relative to the latest date within the filtered period.
///
/// - Rolling X days (PY): Returns the same Rolling X days value, but for the same dates in the previous year.
///   Note that this is based on exact date comparison â€” not by matching calendar week or month numbers.
///   For example, if a specific week is selected, the measure looks at the equivalent dates one year earlier,
///   not the same week number from the previous year.
///
/// - Rolling X days (YOY%): Calculates the Year-over-Year percentage change of the rolling x days measure:
///   ([Rolling X Days] - [Rolling X days (PY)]) / [Rolling X days (PY)].
table 'Time Intelligence'
	lineageTag: 4067c429-0c5a-430e-a01b-a002f6b8a92c

	calculationGroup

		calculationItem Current = SELECTEDMEASURE()

		calculationItem PY =

				VAR SelectedFinancialYear = SELECTEDVALUE(Dates[Financial Year])
				VAR SelectedFinancialQuarter = SELECTEDVALUE(Dates[Financial Quarter])
				VAR SelectedFinancialMonth = SELECTEDVALUE(Dates[Financial Month Number])
				VAR SelectedFinancialWeek = SELECTEDVALUE(Dates[Financial Week])
				VAR SelectedCalendarYear = SELECTEDVALUE(Dates[Calendar Year])
				VAR SelectedCalendarMonth = SELECTEDVALUE(Dates[Calendar Month Number])
				VAR SelectedCalendarMonth = SELECTEDVALUE(Dates[Calendar Quarter Number])

				RETURN
				    SWITCH(
				        TRUE(),

						ISINSCOPE(Dates[Financial Week]),
						CALCULATE(
				            SELECTEDMEASURE(),
				            Dates[Financial Year] = SelectedFinancialYear - 1,
				            Dates[Financial Week] = SelectedFinancialWeek,
				            REMOVEFILTERS(Dates)
				        ),

				        ISINSCOPE(Dates[Date]) || ISINSCOPE(Dates[Calendar Quarter]) || ISINSCOPE(Dates[Calendar Month Number]) || ISINSCOPE(Dates[Calendar Year]),
						CALCULATE(
				            SELECTEDMEASURE(),
				            DATEADD(Dates[Date], -1, YEAR),
				            REMOVEFILTERS(Dates)
				        ),

				        ISINSCOPE(Dates[Financial Month Name]),
						CALCULATE(
				            SELECTEDMEASURE(),
				            Dates[Financial Year] = SelectedFinancialYear - 1,
				            Dates[Financial Month Number] = SelectedFinancialMonth,
				            REMOVEFILTERS(Dates)
				        ),

				        ISINSCOPE(Dates[Financial Quarter]),
						CALCULATE(
				            SELECTEDMEASURE(),
				            Dates[Financial Year] = SelectedFinancialYear - 1,
				            Dates[Financial Quarter] = SelectedFinancialQuarter,
				            REMOVEFILTERS(Dates)
				        ),

				        ISINSCOPE(Dates[Financial Year]),
						CALCULATE(
				            SELECTEDMEASURE(),
				            Dates[Financial Year] = SelectedFinancialYear - 1,
				            REMOVEFILTERS(Dates)
				        ),

                        CALCULATE(
				            SELECTEDMEASURE(),
				            SAMEPERIODLASTYEAR(Dates[Date]),
				            REMOVEFILTERS(Dates)
				        )

				    )

		calculationItem 'Diff PY' =
				SELECTEDMEASURE() -
				    CALCULATE(
				        SELECTEDMEASURE(),
				        'Time Intelligence'[Time Calculation] = "PY"
				    )

		calculationItem YOY% =
				DIVIDE(
				    CALCULATE(
				        SELECTEDMEASURE(),
				        'Time Intelligence'[Time Calculation]="Diff PY"
				    ),
				    CALCULATE(
				        SELECTEDMEASURE(),
				        'Time Intelligence'[Time Calculation]="PY"
				    )
				)

			formatStringDefinition = "0.00%;-0.00%;0.00%"

		calculationItem CY/PY =
			DIVIDE(
				CALCULATE(
					SELECTEDMEASURE(),
					'Time Intelligence'[Time Calculation]="Current"
				),
				CALCULATE(
					SELECTEDMEASURE(),
					'Time Intelligence'[Time Calculation]="PY"
				)
			)

		calculationItem YTD =

			VAR SelectedFinancialYear = SELECTEDVALUE(Dates[Financial Year])
			VAR LastWeekAvailable = CALCULATE( MAX(Dates[Financial Week]), Dates[is_future_menu_week] = false)

			RETURN
				SWITCH(
					TRUE(),

					ISINSCOPE(Dates[Date]) || ISINSCOPE(Dates[Calendar Quarter]) || ISINSCOPE(Dates[Calendar Month Number]) || ISINSCOPE(Dates[Calendar Year]),
					TOTALYTD(
						SELECTEDMEASURE(),
						Dates[Date],
						REMOVEFILTERS(Dates)
					),

					ISINSCOPE(Dates[Financial Year]),
					CALCULATE(
						SELECTEDMEASURE(),
						Dates[Financial Year] = SelectedFinancialYear,
						Dates[Financial Week] <= LastWeekAvailable,
						REMOVEFILTERS(Dates)
					),

					TOTALYTD(
						SELECTEDMEASURE(),
						Dates[Date],
						REMOVEFILTERS(Dates)
					)
				)

		calculationItem PYTD =

			VAR PreviousFinancialYear = SELECTEDVALUE(Dates[Financial Year]) - 1
			VAR LastWeekAvailable = CALCULATE( MAX(Dates[Financial Week]), Dates[is_future_menu_week] = false)

			RETURN
				SWITCH(
					TRUE(),

					ISINSCOPE(Dates[Date]) || ISINSCOPE(Dates[Calendar Quarter]) || ISINSCOPE(Dates[Calendar Month Number]) || ISINSCOPE(Dates[Calendar Year]),
					CALCULATE(
						TOTALYTD(
							SELECTEDMEASURE(),
							Dates[Date]
						),
						DATEADD(Dates[Date], -1, YEAR),
						REMOVEFILTERS(Dates)
					),

					ISINSCOPE(Dates[Financial Year]), CALCULATE(
						SELECTEDMEASURE(),
						'Dates'[Financial Year] = PreviousFinancialYear,
						'Dates'[Financial Week] <= LastWeekAvailable,
						REMOVEFILTERS(Dates)
					),

					TOTALYTD(
						CALCULATE(
							SELECTEDMEASURE(),
							'Time Intelligence'[Time Calculation]="PY"
						),
						Dates[Date],
						REMOVEFILTERS(Dates)
					)
				)

		calculationItem 'Rolling X days' =
			VAR X = '(Param) Days in Rolling Period'[Days in Rolling Period Value]
			RETURN
			CALCULATE(
				SELECTEDMEASURE(),
				REMOVEFILTERS(Dates),
				Dates[Date] <= MAX(Dates[Date]),
				Dates[Date] > MAX(Dates[Date]) - X
			)

		calculationItem 'Rolling X days (PY)' =
			VAR X = '(Param) Days in Rolling Period'[Days in Rolling Period Value]
			VAR EndDate =
                CALCULATE(
                    MAX(Dates[Date]),
                    DATEADD(Dates[Date],-1,YEAR),
					REMOVEFILTERS(Dates)
                )
            VAR StartDate = EndDate - X
			RETURN
			CALCULATE(
				SELECTEDMEASURE(),
				REMOVEFILTERS(Dates),
				Dates[Date] > StartDate,
        		Dates[Date] <= EndDate
			)

		calculationItem 'Rolling X days (YOY%)' =
			VAR DiffPY =
				CALCULATE(
					SELECTEDMEASURE(),
					'Time Intelligence'[Time Calculation]="Rolling X days"
				)
				-
				CALCULATE(
					SELECTEDMEASURE(),
					'Time Intelligence'[Time Calculation]="Rolling X days (PY)"
				)

			VAR PY =
				CALCULATE(
					SELECTEDMEASURE(),
					'Time Intelligence'[Time Calculation]="Rolling X days (PY)"
				)

			RETURN
			DIVIDE(
				DiffPY,
				PY
			)

	column 'Time Calculation'
		dataType: string
		lineageTag: 62edac33-e451-4d18-8c03-e0299694591d
		summarizeBy: none
		sourceColumn: Name
		sortByColumn: Ordinal

		annotation SummarizationSetBy = Automatic

	column Ordinal
		dataType: int64
		formatString: 0
		lineageTag: 5ac4bd59-eb39-4494-b338-9df444561eba
		summarizeBy: sum
		sourceColumn: Ordinal

		annotation SummarizationSetBy = Automatic
