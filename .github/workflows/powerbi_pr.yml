name: Power BI PR

#Uses the following https://www.kevinrchant.com/2024/02/23/upgrading-an-existing-power-bi-project-to-include-tmdl-file-format/
#.. and https://learn.microsoft.com/en-us/power-bi/developer/projects/projects-build-pipelines?WT.mc_id=DP-MVP-5004032
#.. translated to github actions by chat gpt https://chatgpt.com/c/66e41dda-59b8-8002-bdf6-6d7c5cef3247

on: 
  pull_request:
    paths:
      - '.github/workflows/powerbi_pr.yml'
      - 'projects/powerbi**'

  workflow_run:
    workflows: ["Data Model PR"]
    types:
      - completed

  workflow_dispatch:

jobs:
  Build_Datasets:
    name: Build and test semantic model
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Download Tabular Editor and Default Rules
      shell: pwsh
      run: |
        $path = "${{ github.workspace }}"
        $tempPath = "$path/_temp"
        $toolPath = "$path/_tools/TE"
        New-Item -ItemType Directory -Path $tempPath -ErrorAction SilentlyContinue | Out-Null  

        Write-Host "Downloading Tabular Editor binaries"
        $downloadUrl = "https://github.com/TabularEditor/TabularEditor/releases/latest/download/TabularEditor.Portable.zip"
        $zipFile = "$tempPath/TabularEditor.zip"
        Invoke-WebRequest -Uri $downloadUrl -OutFile $zipFile
        Expand-Archive -Path $zipFile -DestinationPath $toolPath -Force 

    - name: Run Dataset Rules
      shell: pwsh
      run: |
        $path = "${{ github.workspace }}"
        $tempPath = "$path/_temp"
        $toolPath = "$path/_Tools/TE/TabularEditor.exe"
        $rulesPath = "$path/Rules-Dataset.json"
        $rulesPath = "$path/projects/powerbi/Rules-Dataset.json"
        if (!(Test-Path $rulesPath))
        {
            Write-Host "Couldn't find rules"
        }
        $itemsFolders = Get-ChildItem  -Path $path -recurse -include ("*.pbidataset", "*.pbism")
        foreach($itemFolder in $itemsFolders)
        {	
            $itemPath = "$($itemFolder.Directory.FullName)/definition"
            if (!(Test-Path $itemPath))
            {
                $itemPath = "$($itemFolder.Directory.FullName)/model.bim"
                if (!(Test-Path $itemPath))
                {
                    throw "Cannot find semantic model definition."
                }
            }
            Write-Host "Running rules for: '$itemPath'"
            Start-Process -FilePath "$toolPath" -ArgumentList """$itemPath"" -A ""$rulesPath"" -V" -NoNewWindow -Wait
            Write-Host "Rules run complete"
        }

  publish_semantic_model:
    name: Publish and refresh semantic model in Cheffelo [dev]
    uses: ./.github/workflows/powerbi_template.yml
    with:
      target-env: Development
    secrets: inherit
    